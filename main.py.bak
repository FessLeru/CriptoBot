import asyncio
import os
import time
from datetime import datetime, timedelta, timezone
import math
import uuid
import traceback
import abc
from typing import Dict, List, Optional, Tuple, Any, Union, Callable, Awaitable
import platform
import sys
import json
import hmac
import hashlib
import base64
import aiohttp

import ccxt.async_support as ccxt
import pandas as pd
import numpy as np
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import Message, FSInputFile
from dotenv import load_dotenv
from bot_logging import BotLogger, logger as general_logger
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment, Border, Side
from config import REPORTS_DIR, TRADES_EXCEL_FILE, EXCEL_STYLES, TRADE_DIRECTION
from trade_reporter import TradeReporter
from strategies import Strategy
from strategies.BTC_strategy import BTCStrategy
from strategies.ETH_strategy import ETHStrategy
import winloop
winloop.install()

# –°–æ–∑–¥–∞–µ–º –ª–æ–≥–≥–µ—Ä –±–æ—Ç–∞
bot_logger = BotLogger(name="trading_bot", log_dir="logs")
logger = bot_logger.main_logger

# --- Configuration ---
TARGET_CHAT_ID = -1002586914018  # ID —á–∞—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
TIMEFRAME = "45m"  # 15-–º–∏–Ω—É—Ç–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º - –æ—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π, –Ω–æ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

# –°–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ Bitget
SUPPORTED_TIMEFRAMES = [
    "1m", "3m", "5m", "15m", "30m", "45m",
    "1H", "4H", "6H", "12H", 
    "1D", "1W", "1M",
    "6Hutc", "12Hutc", "1Dutc", "3Dutc", "1Wutc", "1Mutc"
]

# --- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ---
FRAMA_LENGTH = 10
STC_LENGTH = 21
VFI_LENGTH = 100
FIXED_SL_PCT = 0.5  # 0.5% —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–æ–ø-–ª–æ—Å—Å
TRAIL_TRIGGER_PCT = 0.7  # 0.7% –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø–∞
TRAIL_STEP_PCT = 0.25  # 0.25% —à–∞–≥ —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø–∞
TRAIL_MODE = True

# --- –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env ---
load_dotenv()

# --- API ---
API_KEY = os.getenv("API_KEY")
SECRET_KEY = os.getenv("SECRET_KEY")
PASSPHRASE = os.getenv("PASSPHRASE")
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")

# --- –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–¥–µ–ª–æ–∫ ---
TRADES_FILE = "trades_history.xlsx"
all_trades_history = []  # –°–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Å–¥–µ–ª–æ–∫

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–ª—é—á–µ–π
if not API_KEY or not SECRET_KEY or not PASSPHRASE:
    raise ValueError("API keys are missing. Please check your .env file.")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ Bitget
exchange = ccxt.bitget({
    'apiKey': API_KEY,
    'secret': SECRET_KEY,
    'password': PASSPHRASE,
    'options': {'defaultType': 'swap'},  # –§—å—é—á–µ—Ä—Å—ã Bitget
    'enableRateLimit': True
})

# --- API Telegram ---
bot = Bot(token=TOKEN)
dp = Dispatcher()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ—Ä—Ç–µ—Ä–∞ —Å–¥–µ–ª–æ–∫
trade_reporter = TradeReporter(exchange)

leverage = 20
active_trades = {}
message_processing_lock = asyncio.Lock()

# –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–µ–¥–∞–≤–Ω–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
recent_signals = {}
# –í—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö, –≤ —Ç–µ—á–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–∏–≥–Ω–∞–ª —Å—á–∏—Ç–∞–µ—Ç—Å—è "–Ω–µ–¥–∞–≤–Ω–∏–º"
SIGNAL_COOLDOWN = 300  # 5 –º–∏–Ω—É—Ç

# –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
active_strategies = {}

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
bot_config = {
    "timeframe": TIMEFRAME,
    "trade_direction": TRADE_DIRECTION,
    "leverage": leverage,
    "supported_timeframes": ", ".join(SUPPORTED_TIMEFRAMES),
    "fixed_sl_pct": FIXED_SL_PCT,
    "trail_trigger_pct": TRAIL_TRIGGER_PCT,
    "trail_step_pct": TRAIL_STEP_PCT
}
bot_logger.log_bot_start(version="1.0.0", config=bot_config)

# –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
def initialize_strategies():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è –≤—Å–µ—Ö –º–æ–Ω–µ—Ç"""
    btc_strategy = BTCStrategy(exchange, trade_direction=TRADE_DIRECTION)
    eth_strategy = ETHStrategy(exchange, trade_direction=TRADE_DIRECTION)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤ —Å–ª–æ–≤–∞—Ä–µ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    active_strategies["BTC/USDT"] = btc_strategy
    active_strategies["ETH/USDT"] = eth_strategy
    
    logger.info(f"–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã: {', '.join(active_strategies.keys())}")
    
    # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    for symbol, strategy in active_strategies.items():
        logger.info(f"–°—Ç—Ä–∞—Ç–µ–≥–∏—è {strategy.name} –¥–ª—è {symbol}:")
        logger.info(f"  - –¢–∞–π–º—Ñ—Ä–µ–π–º: {strategy.timeframe}")
        logger.info(f"  - FRAMA –¥–ª–∏–Ω–∞: {strategy.frama_length}")
        logger.info(f"  - STC –¥–ª–∏–Ω–∞: {strategy.stc_length}")
        logger.info(f"  - VFI –¥–ª–∏–Ω–∞: {strategy.vfi_length}")
        logger.info(f"  - –°—Ç–æ–ø-–ª–æ—Å—Å: {strategy.fixed_sl_pct}%")
        logger.info(f"  - –¢—Ä–µ–π–ª–∏–Ω–≥-—Ç—Ä–∏–≥–≥–µ—Ä: {strategy.trail_trigger_pct}%")
        logger.info(f"  - –®–∞–≥ —Ç—Ä–µ–π–ª–∏–Ω–≥–∞: {strategy.trail_step_pct}%")
    
    return list(active_strategies.keys())

# –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–æ–Ω–µ—Ç —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏
POPULAR_COINS = initialize_strategies()

# --- –ö–æ–º–∞–Ω–¥–∞ /timeframe ---
@dp.message(Command("timeframe"))
async def handle_timeframe(message: Message):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –¥–ª—è –≤—Å–µ—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π.
    –§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã: /timeframe <–∑–Ω–∞—á–µ–Ω–∏–µ>
    """
    global TIMEFRAME
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    text = message.text.strip()
    
    # –†–∞–∑–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ —á–∞—Å—Ç–∏ (–∫–æ–º–∞–Ω–¥–∞ –∏ –∞—Ä–≥—É–º–µ–Ω—Ç)
    args = text.split()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã
    if len(args) != 2:
        await message.reply(
            f"‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ: /timeframe <–∑–Ω–∞—á–µ–Ω–∏–µ>\n"
            f"–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã: {', '.join(SUPPORTED_TIMEFRAMES)}"
        )
        return
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ
    new_timeframe = args[1]
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º lowercase —Ñ–æ—Ä–º–∞—Ç –≤ uppercase –¥–ª—è —á–∞—Å–æ–≤/–¥–Ω–µ–π/–Ω–µ–¥–µ–ª—å/–º–µ—Å—è—Ü–µ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º Bitget
    if new_timeframe.endswith('h'):
        new_timeframe = new_timeframe.replace('h', 'H')
    if new_timeframe.endswith('d'):
        new_timeframe = new_timeframe.replace('d', 'D')
    if new_timeframe.endswith('w'):
        new_timeframe = new_timeframe.replace('w', 'W')
    if new_timeframe == '1m' or new_timeframe == '3m' or new_timeframe == '5m' or \
       new_timeframe == '15m' or new_timeframe == '30m' or new_timeframe == '45m':
        # –ú–∏–Ω—É—Ç—ã –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
        pass 
    else:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–µ—Å—è—Ü (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª–∞–≤–Ω—É—é M)
        if new_timeframe.lower() == '1m':
            new_timeframe = '1M'
        
    logger.info(f"–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º: {new_timeframe}, –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ª–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º
    if new_timeframe not in SUPPORTED_TIMEFRAMES:
        await message.reply(
            f"‚ö†Ô∏è –£–∫–∞–∑–∞–Ω –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º!\n"
            f"–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã: {', '.join(SUPPORTED_TIMEFRAMES)}"
        )
        return
    
    # –ú–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    old_timeframe = TIMEFRAME
    TIMEFRAME = new_timeframe
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º—Ñ—Ä–µ–π–º –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
    for symbol, strategy in active_strategies.items():
        strategy.set_timeframe(new_timeframe)
        logger.info(f"–û–±–Ω–æ–≤–ª–µ–Ω —Ç–∞–π–º—Ñ—Ä–µ–π–º –¥–ª—è {symbol}: {old_timeframe} -> {new_timeframe}")
    
    logger.info(f"–¢–∞–π–º—Ñ—Ä–µ–π–º –∏–∑–º–µ–Ω–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π: {old_timeframe} -> {TIMEFRAME} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.from_user.id})")
    
    # –ò–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± —É—Å–ø–µ—à–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    await message.reply(
        f"‚úÖ –¢–∞–π–º—Ñ—Ä–µ–π–º —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π: {old_timeframe} ‚Üí {TIMEFRAME}\n"
        f"–¢–µ–ø–µ—Ä—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –Ω–∞ —Ç–∞–π–º—Ñ—Ä–µ–π–º–µ {TIMEFRAME}"
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ü–µ–ª–µ–≤–æ–π —á–∞—Ç
    if message.chat.id != TARGET_CHAT_ID:
        await bot.send_message(
            TARGET_CHAT_ID,
            f"‚ÑπÔ∏è –¢–∞–π–º—Ñ—Ä–µ–π–º –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {TIMEFRAME} –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π"
        )

# --- –ö–æ–º–∞–Ω–¥–∞ /coin_timeframe ---
@dp.message(Command("coin_timeframe"))
async def handle_coin_timeframe(message: Message):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π –º–æ–Ω–µ—Ç—ã.
    –§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã: /coin_timeframe <–º–æ–Ω–µ—Ç–∞> <–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞>
    –ü—Ä–∏–º–µ—Ä: /coin_timeframe BTC 15m
    """
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    text = message.text.strip()
    
    # –†–∞–∑–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ —á–∞—Å—Ç–∏
    args = text.split()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã
    if len(args) != 3:
        await message.reply(
            f"‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ: /coin_timeframe <–º–æ–Ω–µ—Ç–∞> <–∑–Ω–∞—á–µ–Ω–∏–µ>\n"
            f"–ù–∞–ø—Ä–∏–º–µ—Ä: /coin_timeframe BTC 15m\n"
            f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–Ω–µ—Ç—ã: {', '.join([coin.split('/')[0] for coin in active_strategies.keys()])}\n"
            f"–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã: {', '.join(SUPPORTED_TIMEFRAMES)}"
        )
        return
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –º–æ–Ω–µ—Ç—É –∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º
    coin_code = args[1].upper()
    new_timeframe = args[2]
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è —Å–∏–º–≤–æ–ª–∞
    full_symbol = f"{coin_code}/USDT"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π –º–æ–Ω–µ—Ç—ã
    if full_symbol not in active_strategies:
        await message.reply(
            f"‚ö†Ô∏è –î–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π –º–æ–Ω–µ—Ç—ã –Ω–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.\n"
            f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–Ω–µ—Ç—ã: {', '.join([coin.split('/')[0] for coin in active_strategies.keys()])}"
        )
        return
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–∞–π–º—Ñ—Ä–µ–π–º —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º Bitget
    if new_timeframe.endswith('h'):
        new_timeframe = new_timeframe.replace('h', 'H')
    if new_timeframe.endswith('d'):
        new_timeframe = new_timeframe.replace('d', 'D')
    if new_timeframe.endswith('w'):
        new_timeframe = new_timeframe.replace('w', 'W')
    if new_timeframe == '1m' or new_timeframe == '3m' or new_timeframe == '5m' or \
       new_timeframe == '15m' or new_timeframe == '30m' or new_timeframe == '45m':
        # –ú–∏–Ω—É—Ç—ã –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
        pass 
    else:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–µ—Å—è—Ü (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª–∞–≤–Ω—É—é M)
        if new_timeframe.lower() == '1m':
            new_timeframe = '1M'
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ª–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º
    if new_timeframe not in SUPPORTED_TIMEFRAMES:
        await message.reply(
            f"‚ö†Ô∏è –£–∫–∞–∑–∞–Ω –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º!\n"
            f"–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã: {', '.join(SUPPORTED_TIMEFRAMES)}"
        )
        return
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∏ —Ç–µ–∫—É—â–∏–π —Ç–∞–π–º—Ñ—Ä–µ–π–º
    strategy = active_strategies[full_symbol]
    old_timeframe = strategy.timeframe
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –¥–ª—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    strategy.set_timeframe(new_timeframe)
    
    logger.info(f"–¢–∞–π–º—Ñ—Ä–µ–π–º –∏–∑–º–µ–Ω–µ–Ω –¥–ª—è {full_symbol}: {old_timeframe} -> {new_timeframe} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.from_user.id})")
    
    # –ò–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± —É—Å–ø–µ—à–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    await message.reply(
        f"‚úÖ –¢–∞–π–º—Ñ—Ä–µ–π–º —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω –¥–ª—è {full_symbol}: {old_timeframe} ‚Üí {new_timeframe}"
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ü–µ–ª–µ–≤–æ–π —á–∞—Ç
    if message.chat.id != TARGET_CHAT_ID:
        await bot.send_message(
            TARGET_CHAT_ID,
            f"‚ÑπÔ∏è –¢–∞–π–º—Ñ—Ä–µ–π–º –¥–ª—è {full_symbol} –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {new_timeframe}"
        )

# --- –ö–æ–º–∞–Ω–¥–∞ /strategy_status ---
@dp.message(Command("strategy_status"))
async def handle_strategy_status(message: Message):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∏ –∏—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã.
    """
    status_message = "üìä *–°—Ç–∞—Ç—É—Å —Å—Ç—Ä–∞—Ç–µ–≥–∏–π:*\n\n"
    
    for symbol, strategy in active_strategies.items():
        status_message += f"üîπ *{symbol}*\n"
        status_message += f"   –¢–∞–π–º—Ñ—Ä–µ–π–º: {strategy.timeframe}\n"
        status_message += f"   –°—Ç—Ä–∞—Ç–µ–≥–∏—è: {strategy.name}\n"
        status_message += f"   FRAMA: {strategy.frama_length}, STC: {strategy.stc_length}, VFI: {strategy.vfi_length}\n"
        status_message += f"   –°—Ç–æ–ø-–ª–æ—Å—Å: {strategy.fixed_sl_pct}%, –¢—Ä–µ–π–ª–∏–Ω–≥: {strategy.trail_trigger_pct}%/{strategy.trail_step_pct}%\n\n"
    
    await message.reply(status_message, parse_mode="Markdown")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Å–¥–µ–ª–∫–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
def save_trade_to_history(trade_data):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Å–¥–µ–ª–∫–µ –≤ –∏—Å—Ç–æ—Ä–∏—é"""
    global all_trades_history
    all_trades_history.append(trade_data)
    logger.info(f"–°–¥–µ–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é: {trade_data}")

async def scan_all_coins():
    """–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –º–æ–Ω–µ—Ç —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ (–¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)"""
    logger.info("–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –º–æ–Ω–µ—Ç")
    scan_count = 0
    signal_count = 0

    for symbol, strategy in active_strategies.items():
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–π–¥–∞ –ø–æ —ç—Ç–æ–º—É —Å–∏–º–≤–æ–ª—É
            if symbol in active_trades:
                logger.info(f"–ü—Ä–æ–ø—É—Å–∫ {symbol} - —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–π–¥")
                continue
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –Ω–µ–¥–∞–≤–Ω–æ –ø–æ–ª—É—á–µ–Ω –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω —Å–∏–≥–Ω–∞–ª –ø–æ —ç—Ç–æ–º—É —Å–∏–º–≤–æ–ª—É
            current_time = datetime.now()
            if symbol in recent_signals:
                last_signal_time, last_signal_type = recent_signals[symbol]
                time_diff = (current_time - last_signal_time).total_seconds()
                
                if time_diff < SIGNAL_COOLDOWN:
                    logger.info(f"–ü—Ä–æ–ø—É—Å–∫ {symbol} - –Ω–µ–¥–∞–≤–Ω–æ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω —Å–∏–≥–Ω–∞–ª ({time_diff:.1f} —Å–µ–∫. –Ω–∞–∑–∞–¥)")
                    continue
            
            logger.info(f"–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ {symbol} –Ω–∞ —Ç–∞–π–º—Ñ—Ä–µ–π–º–µ {strategy.timeframe}")
            scan_count += 1
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
            signal = await strategy.execute()
            
            if signal:
                signal_count += 1
                
                # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π
                recent_signals[symbol] = (current_time, signal["type"])
                
                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–∏–≥–Ω–∞–ª–µ
                signal_type = "üü¢ –õ–û–ù–ì" if signal["type"] == "buy" else "üî¥ –®–û–†–¢"
                trail_status = "‚úÖ –ê–∫—Ç–∏–≤–µ–Ω" if signal.get("trail_mode", True) else "‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω"
                fixed_sl_pct = strategy.fixed_sl_pct
                trail_trigger_pct = strategy.trail_trigger_pct
                trail_step_pct = strategy.trail_step_pct
                
                message = f"""üö® –°–ò–ì–ù–ê–õ: {signal_type} –Ω–∞ {symbol}!
üí∞ –¶–µ–Ω–∞: {signal['price']:.4f} USDT
üõë –°—Ç–æ–ø-–ª–æ—Å—Å: {signal['stop_loss']:.4f} USDT ({fixed_sl_pct}%)
üîÑ –¢—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø: {trail_status}
üìä –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ç—Ä–µ–π–ª–∏–Ω–≥–∞: {trail_trigger_pct}%
üìä –®–∞–≥ —Ç—Ä–µ–π–ª–∏–Ω–≥–∞: {trail_step_pct}%
‚è± –í—Ä–µ–º—è: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
üîç –¢–∞–π–º—Ñ—Ä–µ–π–º: {strategy.timeframe}
üîç –°—Ç—Ä–∞—Ç–µ–≥–∏—è: {strategy.name}
"""
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
                await bot.send_message(TARGET_CHAT_ID, message)
                
                # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–¥–µ–ª–∫—É
                trade_result = await open_trade(signal)
                await bot.send_message(TARGET_CHAT_ID, trade_result)
                
                # –î–µ–ª–∞–µ–º –ø–∞—É–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–¥–µ–ª–∫–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –º–æ–Ω–µ—Ç–µ
                await asyncio.sleep(1)
                continue
            else:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ —Å–∏–≥–Ω–∞–ª–∞
                current_price = None
                try:
                    # –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
                    ticker = await exchange.fetch_ticker(symbol)
                    current_price = ticker['last']
                except Exception as price_error:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã –¥–ª—è {symbol}: {price_error}")
                
                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                scan_report = f"‚úì {symbol} –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Ç–∞–π–º—Ñ—Ä–µ–π–º–µ {strategy.timeframe}"
                if current_price:
                    scan_report += f" | –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: {current_price:.4f} USDT"
                scan_report += f" | {datetime.now().strftime('%H:%M:%S')}"
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –≤ Telegram
                await bot.send_message(TARGET_CHAT_ID, scan_report)
                
                # –î–µ–ª–∞–µ–º –ø–∞—É–∑—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
                await asyncio.sleep(1)
    except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ {symbol}: {str(e)}")
            logger.error(traceback.format_exc())
        
        # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∫ API
        await asyncio.sleep(0.5)
    
    # –°–æ–æ–±—â–µ–Ω–∏–µ –∏ –ª–æ–≥ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    end_message = f"‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –º–æ–Ω–µ—Ç: {scan_count}, –Ω–∞–π–¥–µ–Ω–æ —Å–∏–≥–Ω–∞–ª–æ–≤: {signal_count}. –í—Ä–µ–º—è: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
    await bot.send_message(TARGET_CHAT_ID, end_message)
    logger.info(end_message)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    return {"scan_count": scan_count, "signal_count": signal_count}


async def open_trade(signal):
    """–û—Ç–∫—Ä—ã—Ç–∏–µ —Å–¥–µ–ª–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–≥–Ω–∞–ª–∞ (–∏—Å–ø–æ–ª—å–∑—É—è CCXT)"""
    global active_trades
    
    symbol = signal["symbol"]
    side = signal["type"]  # "buy" –∏–ª–∏ "sell"
    signal_price = signal["price"]  # –¶–µ–Ω–∞ –∏–∑ —Å–∏–≥–Ω–∞–ª–∞
    stop_loss = signal["stop_loss"]
    take_profit = signal.get("take_profit", None)
    trail_mode = signal["trail_mode"]
    positionSide = "long" if side == "buy" else "short"
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–π–¥–∞ –ø–æ —ç—Ç–æ–º—É —Å–∏–º–≤–æ–ª—É
        if symbol in active_trades:
            return f"‚ö†Ô∏è –£–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–π–¥ –ø–æ {symbol}"
            
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ä—ã–Ω–æ—á–Ω—É—é —Ü–µ–Ω—É
        try:
            ticker = await exchange.fetch_ticker(symbol)
            current_price = ticker['last']
            logger.info(f"–¢–µ–∫—É—â–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ {symbol}: {current_price}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã —Å–∏–≥–Ω–∞–ª–∞ –æ—Ç —Ç–µ–∫—É—â–µ–π —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω—ã
            price_deviation_pct = abs((signal_price - current_price) / current_price) * 100
            logger.info(f"–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã —Å–∏–≥–Ω–∞–ª–∞ –æ—Ç —Ä—ã–Ω–æ—á–Ω–æ–π: {price_deviation_pct:.2f}%")
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é —Ä—ã–Ω–æ—á–Ω—É—é —Ü–µ–Ω—É –≤–º–µ—Å—Ç–æ —Ü–µ–Ω—ã –∏–∑ —Å–∏–≥–Ω–∞–ª–∞
            price = current_price
            
            # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å—Ç–æ–ø-–ª–æ—Å—Å –∏ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
            if side == "buy":
                # –î–ª—è –ª–æ–Ω–≥–∞: —Å—Ç–æ–ø –Ω–∏–∂–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
                stop_loss = current_price * (1 - FIXED_SL_PCT / 100)
                if take_profit:
                    # –¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2% –æ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã)
                    take_profit = current_price * (1 + 2 / 100)
            else:
                # –î–ª—è —à–æ—Ä—Ç–∞: —Å—Ç–æ–ø –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
                stop_loss = current_price * (1 + FIXED_SL_PCT / 100)
                if take_profit:
                    # –¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç –Ω–∏–∂–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
                    take_profit = current_price * (1 - 2 / 100)
                    
            logger.info(f"–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: —Ü–µ–Ω–∞={price}, —Å—Ç–æ–ø-–ª–æ—Å—Å={stop_loss}, —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç={take_profit}")
                
        except Exception as ticker_error:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã: {ticker_error}")
            return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã: {str(ticker_error)}"
            
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–µ—á–æ
        await set_leverage_for_symbol(symbol, leverage)
            
        # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å —Ñ—å—é—á–µ—Ä—Å–æ–≤
        usdt_balance = await get_balance()
        
        logger.info(f"üìà –ë–∞–ª–∞–Ω—Å —Ñ—å—é—á–µ—Ä—Å–æ–≤ USDT: {usdt_balance:.2f}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
        if usdt_balance < 4:  # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥
            return f"‚ö†Ô∏è –û—à–∏–±–∫–∞: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Ñ—å—é—á–µ—Ä—Å–∞—Ö ({usdt_balance:.2f} USDT)"
            
        # –†–∞—Å—á–µ—Ç –æ–±—ä–µ–º–∞ –æ—Ä–¥–µ—Ä–∞ (15% –æ—Ç –±–∞–ª–∞–Ω—Å–∞ —Å —É—á–µ—Ç–æ–º –ø–ª–µ—á–∞)
        order_amount = ((usdt_balance / 100) * 15 * leverage) / price
        
        # –¢–æ—á–Ω–æ—Å—Ç—å –æ–±—ä–µ–º–∞ –¥–ª—è —Å–∏–º–≤–æ–ª–∞
        try:
            order_amount = await exchange.amount_to_precision(symbol, order_amount)
            order_amount = float(order_amount)
            logger.info(f"–û–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–º –æ—Ä–¥–µ—Ä–∞: {order_amount}")
        except Exception as precision_error:
            logger.warning(f"–û—à–∏–±–∫–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –æ–±—ä–µ–º–∞: {precision_error}, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —Å–¥–µ–ª–∫–∏
        trade_id = str(uuid.uuid4())
            
        # –í—ã–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –æ—Ä–¥–µ—Ä–∞
        logger.info(
            f"üöÄ –û—Ç–∫—Ä—ã—Ç–∏–µ —Å–¥–µ–ª–∫–∏ –Ω–∞ –§–¨–Æ–ß–ï–†–°–ê–•: {symbol}, {side.upper()}, {order_amount} –ø–æ —Ü–µ–Ω–µ {price:.4f}"
        )
            
        # 1. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ä—ã–Ω–æ—á–Ω—ã–π –æ—Ä–¥–µ—Ä —á–µ—Ä–µ–∑ CCXT
        logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä—ã–Ω–æ—á–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ –¥–ª—è {symbol} —á–µ—Ä–µ–∑ CCXT")
        
        # –ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ä–¥–µ—Ä–∞ –¥–ª—è Bitget —á–µ—Ä–µ–∑ CCXT
        order_params = {
            "marginCoin": "USDT",       # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
            "marginMode": "isolated",    # –†–µ–∂–∏–º –º–∞—Ä–∂–∏
        }
        
        try:
            # –î–ª—è —Ä—ã–Ω–æ—á–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ –Ω–∞ –ø–æ–∫—É–ø–∫—É Bitget —Ç—Ä–µ–±—É–µ—Ç price –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
            if side == "buy":
                # –†–µ—à–µ–Ω–∏–µ 1: –ü–µ—Ä–µ–¥–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä createMarketBuyOrderRequiresPrice=False
                # –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º amount –∫–∞–∫ —Å—É–º–º—É –≤ USDT, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏–º –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å
                cost_to_spend = order_amount * price
                logger.info(f"–†—ã–Ω–æ—á–Ω—ã–π –æ—Ä–¥–µ—Ä –Ω–∞ –ø–æ–∫—É–ø–∫—É –Ω–∞ —Å—É–º–º—É {cost_to_spend:.2f} USDT")
                
                order = await exchange.create_order(
                    symbol=symbol,
                    type="market",
                    side=side,
                    amount=order_amount,
                    price=price,  # –†–µ—à–µ–Ω–∏–µ 2: –£–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
                    params=order_params
                )
            else:
                # –î–ª—è –ø—Ä–æ–¥–∞–∂–∏ –æ—Ä–¥–µ—Ä —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ
                order = await exchange.create_order(
                    symbol=symbol,
                    type="market",
                    side=side,
                    amount=order_amount,
                    params=order_params
                )
            
            logger.info(f"–û—Å–Ω–æ–≤–Ω–æ–π –æ—Ä–¥–µ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ CCXT: {order}")
            
        except Exception as order_error:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ä–¥–µ—Ä–∞ —á–µ—Ä–µ–∑ CCXT: {order_error}")
            logger.error(traceback.format_exc())
            return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ä–¥–µ—Ä–∞: {str(order_error)}"
            
        # –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
        open_time = datetime.now()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–µ–π–¥–µ
        trade_info = {
            'trade_id': trade_id,
            'order_id': order['id'],
            'symbol': symbol,
            'side': side,
            'amount': order_amount,
            'entry_price': price,
            'stop_loss': stop_loss,
            'take_profit': take_profit,
            'leverage': leverage,
            'open_time': open_time,
            'close_time': None,
            'exit_price': None,
            'pnl': None,
            'status': 'OPEN',
            'trail_mode': trail_mode,
            'trailing_stop_created_at': None
        }
        
        # 2. –°–æ–∑–¥–∞–µ–º —Å—Ç–æ–ø-–ª–æ—Å—Å —á–µ—Ä–µ–∑ CCXT
        try:
            # –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
            close_side = "sell" if side == "buy" else "buy"
            
            # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å—Ç–æ–ø-–ª–æ—Å—Å–∞
            stop_params = {
                "marginCoin": "USDT",
                "marginMode": "isolated",
                "stopPrice": stop_loss,
                "reduceOnly": True,  # –¢–æ–ª—å–∫–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏
            }
            
            logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–æ–ø-–ª–æ—Å—Å –æ—Ä–¥–µ—Ä–∞ –¥–ª—è {symbol} –Ω–∞ —Ü–µ–Ω–µ {stop_loss}")
            
            sl_order = await exchange.create_order(
                symbol=symbol,
                type="stop_market",
                side=close_side,
                amount=order_amount,
                params=stop_params
            )
            
            logger.info(f"–°—Ç–æ–ø-–ª–æ—Å—Å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: {sl_order}")
            trade_info['sl_order_id'] = sl_order['id']
            
        except Exception as sl_error:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞: {sl_error}")
            logger.error(traceback.format_exc())
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —Å—Ç–æ–ø-–ª–æ—Å—Å –Ω–µ —Å–æ–∑–¥–∞–Ω
        
        # 3. –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
        if trail_mode:
            try:
                # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç —Ç—Ä–µ–π–ª–∏–Ω–≥–∞ (callback rate)
                trailing_percent = TRAIL_STEP_PCT  # –®–∞–≥ —Ç—Ä–µ–π–ª–∏–Ω–≥–∞ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
                
                # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä–Ω—É—é —Ü–µ–Ω—É –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥–∞
                if side == "buy":
                    trigger_price = price * (1 + TRAIL_TRIGGER_PCT/100)
                    trigger_price = await exchange.price_to_precision(symbol, trigger_price)
                else:
                    trigger_price = price * (1 - TRAIL_TRIGGER_PCT/100)
                    trigger_price = await exchange.price_to_precision(symbol, trigger_price)
                
                trigger_price = float(trigger_price)
                logger.info(f"–¢—Ä–∏–≥–≥–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞ –¥–ª—è —Ç—Ä–µ–π–ª–∏–Ω–≥–∞: {trigger_price}")
                
                # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø–∞ –ø–æ –ø—Ä–∏–º–µ—Ä—É
                trail_params = {
                    "marginCoin": "USDT",
                    "marginMode": "isolated",
                    "reduceOnly": True,
                    "trailingTriggerPrice": trigger_price,
                    "trailingPercent": trailing_percent
                }
                
                logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø –æ—Ä–¥–µ—Ä–∞ –¥–ª—è {symbol} —Å —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–π —Ü–µ–Ω–æ–π {trigger_price} –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º {trailing_percent}%")
                
                trail_order = await exchange.create_order(
                    symbol=symbol,
                    type="trailing_stop_market",
                    side=close_side,
                    amount=order_amount,
                    params=trail_params
                )
                
                logger.info(f"–¢—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: {trail_order}")
                trade_info['trail_order_id'] = trail_order['id']
                trade_info['trailing_stop_created_at'] = datetime.now()
                
            except Exception as trail_error:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø–∞: {trail_error}")
                logger.error(traceback.format_exc())
                # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø –Ω–µ —Å–æ–∑–¥–∞–Ω
                
        # 4. –ï—Å–ª–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥ –Ω–µ –≤–∫–ª—é—á–µ–Ω, –Ω–æ –∑–∞–¥–∞–Ω —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
        elif take_profit:
            try:
                # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞
                tp_params = {
                    "marginCoin": "USDT",
                    "marginMode": "isolated",
                    "stopPrice": take_profit,
                    "reduceOnly": True,
                }
                
                logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç –æ—Ä–¥–µ—Ä–∞ –¥–ª—è {symbol} –Ω–∞ —Ü–µ–Ω–µ {take_profit}")
                
                tp_order = await exchange.create_order(
                    symbol=symbol,
                    type="take_profit_market",
                    side=close_side,
                    amount=order_amount,
                    params=tp_params
                )
                
                logger.info(f"–¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: {tp_order}")
                trade_info['tp_order_id'] = tp_order['id']
                
            except Exception as tp_error:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞: {tp_error}")
                logger.error(traceback.format_exc())
                # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–¥–µ–ª–∫–µ –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–π–¥—ã
        active_trades[symbol] = trade_info
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–¥–µ–ª–∫–∏
        trade_message = f"""‚úÖ –û—Ç–∫—Ä—ã—Ç–∞ –Ω–æ–≤–∞—è —Å–¥–µ–ª–∫–∞:
üîπ –°–∏–º–≤–æ–ª: {symbol}
üîπ –¢–∏–ø: {'–õ–û–ù–ì' if side == 'buy' else '–®–û–†–¢'}
üîπ –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞: {price:.4f} USDT
üîπ –û–±—ä–µ–º: {order_amount}
üîπ –°—Ç–æ–ø-–ª–æ—Å—Å: {stop_loss:.4f} USDT"""

        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—Ç–æ–ø-–æ—Ä–¥–µ—Ä–∞—Ö 
        if 'sl_order_id' in trade_info:
            trade_message += f"\nüî∏ ID —Å—Ç–æ–ø-–ª–æ—Å—Å–∞: {trade_info['sl_order_id']}"
            
        if 'trail_order_id' in trade_info:
            trade_message += f"\nüîÑ –¢—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø: –í–∫–ª—é—á–µ–Ω (ID: {trade_info['trail_order_id']})"
            trade_message += f"\nüîÑ –¢—Ä–∏–≥–≥–µ—Ä: {TRAIL_TRIGGER_PCT}%, –®–∞–≥: {TRAIL_STEP_PCT}%"
        elif 'tp_order_id' in trade_info:
            trade_message += f"\nüìà –¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç: {take_profit:.4f} USDT (ID: {trade_info['tp_order_id']})"
        
        trade_message += f"""
üîπ –ü–ª–µ—á–æ: {leverage}x
‚è± {open_time.strftime('%Y-%m-%d %H:%M:%S')}"""
            
        return trade_message
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–¥–µ–ª–∫–∏: {str(e)}")
        logger.error(traceback.format_exc())
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —É–¥–∞–ª—è–µ–º —Ç—Ä–µ–π–¥ –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö
        if symbol in active_trades:
            del active_trades[symbol]
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–¥–µ–ª–∫–∏: {str(e)}"

async def set_leverage_for_symbol(symbol, leverage):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–ª–µ—á–æ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞.
    """
    try:
        response = await exchange.set_leverage(leverage, symbol, params={"marginCoin": "USDT"})
        logger.info(f"–ü–ª–µ—á–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ {leverage}: {response}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–ª–µ—á–∞: {str(e)}")
        raise

async def get_balance():
    """–ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å USDT"""
    try:
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
        # —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–º–∞–Ω–¥ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ
        async with asyncio.timeout(10):  # 10 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
            balance = await exchange.fetch_balance({'type': 'swap', 'marginCoin': 'USDT'})
            return balance['total'].get('USDT', 0)
    except asyncio.TimeoutError:
        logger.error("–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞")
        return 0
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: {e}")
        logger.error(traceback.format_exc())
        return 0

async def periodic_scan():
    """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–Ω–µ—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –∏—Ö –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞–º"""
    logger.info("–ó–∞–ø—É—â–µ–Ω–∞ –∑–∞–¥–∞—á–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")
    
    while True:
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
            now = datetime.now()
            
            # –õ–æ–≥–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É (–∫–æ–≥–¥–∞ seconds == 0)
            if now.second == 0:
                active_strategies_status = ", ".join([f"{symbol}({strategy.timeframe})" for symbol, strategy in active_strategies.items()])
                logger.info(f"–ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: {active_strategies_status}")
                
                # –õ–æ–≥–∏—Ä—É–µ–º –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                for symbol, strategy in active_strategies.items():
                    next_scan = strategy.next_scan_time
                    if next_scan:
                        wait_seconds = (next_scan - now).total_seconds()
                        logger.info(f"–°–ª–µ–¥—É—é—â–µ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ {symbol}: {next_scan.strftime('%H:%M:%S')}, —á–µ—Ä–µ–∑ {wait_seconds:.1f} —Å–µ–∫")
            
            # –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            for symbol, strategy in active_strategies.items():
                # –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
                if strategy.next_scan_time is None:
                    strategy.next_scan_time = calculate_next_candle_time(now, strategy.timeframe)
                    logger.info(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è {symbol} ({strategy.timeframe}): "
                               f"{strategy.next_scan_time.strftime('%Y-%m-%d %H:%M:%S')}")
                    continue
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Å—Ç—É–ø–∏–ª–æ –ª–∏ –≤—Ä–µ–º—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                wait_seconds = (strategy.next_scan_time - now).total_seconds()
                
                # –ï—Å–ª–∏ –Ω–∞—á–∞–ª–æ —Å–≤–µ—á–∏ —á–µ—Ä–µ–∑ –º–µ–Ω–µ–µ —á–µ–º 5 —Å–µ–∫—É–Ω–¥ –∏–ª–∏ —É–∂–µ –ø—Ä–æ—à–ª–æ –Ω–µ –±–æ–ª–µ–µ 5 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥, –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                if -5 <= wait_seconds <= 5:
                    logger.info(f"–ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–π —Å–≤–µ—á–∏ –¥–ª—è {symbol} ({strategy.timeframe}): "
                               f"{strategy.next_scan_time.strftime('%Y-%m-%d %H:%M:%S')}. –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...")
                    
                    try:
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–π–¥–∞ –ø–æ —ç—Ç–æ–º—É —Å–∏–º–≤–æ–ª—É
                        if symbol in active_trades:
                            logger.info(f"–ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ {symbol}, —Ç–∞–∫ –∫–∞–∫ —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–π–¥")
                            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                            strategy.next_scan_time = calculate_next_candle_time(now, strategy.timeframe)
                            continue
                
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –Ω–µ–¥–∞–≤–Ω–æ –ø–æ–ª—É—á–µ–Ω –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω —Å–∏–≥–Ω–∞–ª –ø–æ —ç—Ç–æ–º—É —Å–∏–º–≤–æ–ª—É
                        if symbol in recent_signals:
                            last_signal_time, last_signal_type = recent_signals[symbol]
                            time_diff = (now - last_signal_time).total_seconds()
                            
                            if time_diff < SIGNAL_COOLDOWN:
                                logger.info(f"–ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ {symbol} - –Ω–µ–¥–∞–≤–Ω–æ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω —Å–∏–≥–Ω–∞–ª ({time_diff:.1f} —Å–µ–∫. –Ω–∞–∑–∞–¥)")
                                strategy.next_scan_time = calculate_next_candle_time(now, strategy.timeframe)
                                continue
                                
                        # –í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                        signal = await strategy.execute()
            
                        if signal:
                            # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π
                            recent_signals[symbol] = (now, signal["type"])
                            
                            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–∏–≥–Ω–∞–ª–µ
                            signal_type = "üü¢ –õ–û–ù–ì" if signal["type"] == "buy" else "üî¥ –®–û–†–¢"
                            trail_status = "‚úÖ –ê–∫—Ç–∏–≤–µ–Ω" if signal.get("trail_mode", True) else "‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω"
                            fixed_sl_pct = strategy.fixed_sl_pct
                            trail_trigger_pct = strategy.trail_trigger_pct
                            trail_step_pct = strategy.trail_step_pct
                            
                            message = f"""üö® –°–ò–ì–ù–ê–õ: {signal_type} –Ω–∞ {symbol}!
üí∞ –¶–µ–Ω–∞: {signal['price']:.4f} USDT
üõë –°—Ç–æ–ø-–ª–æ—Å—Å: {signal['stop_loss']:.4f} USDT ({fixed_sl_pct}%)
üîÑ –¢—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø: {trail_status}
üìä –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ç—Ä–µ–π–ª–∏–Ω–≥–∞: {trail_trigger_pct}%
üìä –®–∞–≥ —Ç—Ä–µ–π–ª–∏–Ω–≥–∞: {trail_step_pct}%
‚è± –í—Ä–µ–º—è: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
üîç –¢–∞–π–º—Ñ—Ä–µ–π–º: {strategy.timeframe}
üîç –°—Ç—Ä–∞—Ç–µ–≥–∏—è: {strategy.name}
"""
                
                            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
                            await bot.send_message(TARGET_CHAT_ID, message)
                            
                            # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–¥–µ–ª–∫—É
                            trade_result = await open_trade(signal)
                            await bot.send_message(TARGET_CHAT_ID, trade_result)
                        else:
                            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ —Å–∏–≥–Ω–∞–ª–∞
                            current_price = None
                            try:
                                # –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
                                ticker = await exchange.fetch_ticker(symbol)
                                current_price = ticker['last']
                            except Exception as price_error:
                                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã –¥–ª—è {symbol}: {price_error}")
                            
                            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                            scan_report = f"‚úì {symbol} –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Ç–∞–π–º—Ñ—Ä–µ–π–º–µ {strategy.timeframe}"
                            if current_price:
                                scan_report += f" | –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: {current_price:.4f} USDT"
                            scan_report += f" | {datetime.now().strftime('%H:%M:%S')}"
                            
                            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –≤ Telegram
                            await bot.send_message(TARGET_CHAT_ID, scan_report)
                        
                        # –î–µ–ª–∞–µ–º –ø–∞—É–∑—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
                        await asyncio.sleep(1)
                        
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ {symbol}: {str(e)}")
                        logger.error(traceback.format_exc())
                    finally:
                        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
                        new_next_scan = calculate_next_candle_time(now, strategy.timeframe)
                        logger.info(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è {symbol} ({strategy.timeframe}): "
                                  f"{new_next_scan.strftime('%Y-%m-%d %H:%M:%S')}")
                        strategy.next_scan_time = new_next_scan
                
                elif wait_seconds < -10:
                    # –ï—Å–ª–∏ –º—ã —Å–∏–ª—å–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –Ω–∞—á–∞–ª–æ —Å–≤–µ—á–∏, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–π
                    logger.warning(f"–ü—Ä–æ–ø—É—â–µ–Ω–æ –Ω–∞—á–∞–ª–æ —Å–≤–µ—á–∏ –¥–ª—è {symbol} ({strategy.timeframe}) –≤ "
                                  f"{strategy.next_scan_time.strftime('%Y-%m-%d %H:%M:%S')}. –ü–µ—Ä–µ—Ä–∞—Å—á–µ—Ç...")
                    strategy.next_scan_time = calculate_next_candle_time(now, strategy.timeframe)
            
            # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∫–æ—Ä–æ—á–µ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è)
            await asyncio.sleep(0.5)

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")
            logger.error(traceback.format_exc())
            await asyncio.sleep(60)  # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –∂–¥–µ–º –º–∏–Ω—É—Ç—É –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π

def calculate_next_candle_time(now, timeframe):
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å–≤–µ—á–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞.
    
    Args:
        now: –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
        timeframe: –¢–∞–π–º—Ñ—Ä–µ–π–º –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
    
    Returns:
        datetime: –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å–≤–µ—á–∏
    """
    next_candle_time = None
    
    # –†–∞–∑–±–∏—Ä–∞–µ–º —Ç–∞–π–º—Ñ—Ä–µ–π–º –Ω–∞ —á–∏—Å–ª–æ –∏ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è
    if timeframe == '45m':  # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è 45-–º–∏–Ω—É—Ç–Ω–æ–≥–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
        # 45-–º–∏–Ω—É—Ç–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –∏–º–µ–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω: 00:00, 00:45, 01:30, 02:15, 03:00...
        hour = now.hour
        minute = now.minute
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ —Ü–∏–∫–ª–µ (—Ü–∏–∫–ª –∏–∑ 3 —á–∞—Å–æ–≤ –∏–ª–∏ 4 —Å–≤–µ—á–µ–π)
        hour_mod = hour % 3
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∞—è –±—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–∞—è –º–∏–Ω—É—Ç–∞ –Ω–∞—á–∞–ª–∞ —Å–≤–µ—á–∏
        if hour_mod == 0:  # –ß–∞—Å—ã, –∫—Ä–∞—Ç–Ω—ã–µ 3 (0, 3, 6, 9, 12, 15, 18, 21)
            if minute < 45:
                next_minute = 45
                next_hour = hour
            else:
                next_minute = 30
                next_hour = hour + 1
        elif hour_mod == 1:  # –ß–∞—Å—ã –≤–∏–¥–∞ 1, 4, 7, 10, 13, 16, 19, 22
            if minute < 30:
                next_minute = 30
                next_hour = hour
            else:
                next_minute = 15
                next_hour = hour + 1
        else:  # hour_mod == 2, —á–∞—Å—ã –≤–∏–¥–∞ 2, 5, 8, 11, 14, 17, 20, 23
            if minute < 15:
                next_minute = 15
                next_hour = hour
            else:
                next_minute = 0
                next_hour = hour + 1
        
        next_candle_time = now.replace(hour=next_hour, minute=next_minute, second=0, microsecond=0)
        
    elif timeframe.endswith('m') and timeframe != '45m':  # –û–±—ã—á–Ω—ã–µ –º–∏–Ω—É—Ç–Ω—ã–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã
        minutes_value = int(timeframe.replace('m', ''))
        
        # –í—ã—á–∏—Å–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –ø—Ä–æ—à–ª–æ —Å –Ω–∞—á–∞–ª–∞ —á–∞—Å–∞
        minutes_past_hour = now.minute
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–≤–µ—á–∏
        # –î–ª—è –º–∏–Ω—É—Ç–Ω—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫—Ä–∞—Ç–Ω–æ –∑–Ω–∞—á–µ–Ω–∏—é —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ –æ—Ç –Ω–∞—á–∞–ª–∞ —á–∞—Å–∞
        # –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è 5m —ç—Ç–æ 00, 05, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55
        next_minute_mark = ((minutes_past_hour // minutes_value) + 1) * minutes_value
        
        # –ï—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∞—è –æ—Ç–º–µ—Ç–∫–∞ –±–æ–ª—å—à–µ 59, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —á–∞—Å—É
        if next_minute_mark >= 60:
            next_hour = now.hour + 1
            next_minute_mark = next_minute_mark - 60
            next_candle_time = now.replace(hour=next_hour, minute=next_minute_mark, second=0, microsecond=0)
        else:
            next_candle_time = now.replace(minute=next_minute_mark, second=0, microsecond=0)
    
    # –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    elif timeframe.startswith('1H'):  # 1 —á–∞—Å
        # –°–ª–µ–¥—É—é—â–∞—è —Å–≤–µ—á–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–∞—Å–∞
        next_candle_time = now.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1)
        
    elif timeframe.startswith('4H'):  # 4 —á–∞—Å–∞
        # –°–≤–µ—á–∏ 4H –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –≤ 00:00, 04:00, 08:00, 12:00, 16:00, 20:00
        hours_past_day = now.hour
        next_hour_mark = ((hours_past_day // 4) + 1) * 4
        if next_hour_mark >= 24:
            next_day = now + timedelta(days=1)
            next_hour_mark = next_hour_mark - 24
            next_candle_time = next_day.replace(hour=next_hour_mark, minute=0, second=0, microsecond=0)
        else:
            next_candle_time = now.replace(hour=next_hour_mark, minute=0, second=0, microsecond=0)
            
    elif timeframe.startswith('6H'):  # 6 —á–∞—Å–æ–≤
        # –°–≤–µ—á–∏ 6H –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –≤ 00:00, 06:00, 12:00, 18:00
        hours_past_day = now.hour
        next_hour_mark = ((hours_past_day // 6) + 1) * 6
        if next_hour_mark >= 24:
            next_day = now + timedelta(days=1)
            next_hour_mark = next_hour_mark - 24
            next_candle_time = next_day.replace(hour=next_hour_mark, minute=0, second=0, microsecond=0)
        else:
            next_candle_time = now.replace(hour=next_hour_mark, minute=0, second=0, microsecond=0)
            
    elif timeframe.startswith('12H'):  # 12 —á–∞—Å–æ–≤
        # –°–≤–µ—á–∏ 12H –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –≤ 00:00 –∏ 12:00
        if now.hour < 12:
            next_candle_time = now.replace(hour=12, minute=0, second=0, microsecond=0)
        else:
            next_day = now + timedelta(days=1)
            next_candle_time = next_day.replace(hour=0, minute=0, second=0, microsecond=0)
            
    elif timeframe.startswith('1D'):  # 1 –¥–µ–Ω—å
        # –°–≤–µ—á–∏ 1D –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –≤ 00:00 –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è
        next_day = now + timedelta(days=1)
        next_candle_time = next_day.replace(hour=0, minute=0, second=0, microsecond=0)
        
    elif timeframe.startswith('1W'):  # 1 –Ω–µ–¥–µ–ª—è
        # –°–≤–µ—á–∏ 1W –æ–±—ã—á–Ω–æ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 00:00
        days_to_monday = (7 - now.weekday()) % 7
        if days_to_monday == 0 and (now.hour > 0 or now.minute > 0 or now.second > 0):
            days_to_monday = 7  # –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, –Ω–æ –Ω–µ —Ç–æ—á–Ω–æ 00:00, —Ç–æ —Å–ª–µ–¥—É—é—â–∏–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
        next_monday = now + timedelta(days=days_to_monday)
        next_candle_time = next_monday.replace(hour=0, minute=0, second=0, microsecond=0)
        
    elif timeframe.startswith('1M'):  # 1 –º–µ—Å—è—Ü
        # –°–≤–µ—á–∏ 1M –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –≤ 1-–π –¥–µ–Ω—å –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞
        if now.day == 1 and now.hour == 0 and now.minute == 0 and now.second == 0:
            # –ï—Å–ª–∏ —Å–µ–π—á–∞—Å —Ä–æ–≤–Ω–æ –Ω–∞—á–∞–ª–æ –º–µ—Å—è—Ü–∞, —Å–ª–µ–¥—É—é—â–µ–µ –Ω–∞—á–∞–ª–æ —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü
            next_month = now.month + 1
            next_year = now.year
            if next_month > 12:
                next_month = 1
                next_year += 1
            next_candle_time = now.replace(year=next_year, month=next_month, day=1, hour=0, minute=0, second=0, microsecond=0)
        else:
            # –ò–Ω–∞—á–µ, —Å–ª–µ–¥—É—é—â–µ–µ –Ω–∞—á–∞–ª–æ - 1-–π –¥–µ–Ω—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
            next_month = now.month + 1
            next_year = now.year
            if next_month > 12:
                next_month = 1
                next_year += 1
            next_candle_time = datetime(year=next_year, month=next_month, day=1, hour=0, minute=0, second=0)
    
    else:
        # –î–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ - 15 –º–∏–Ω—É—Ç
        logger.warning(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞: {timeframe}. –ò—Å–ø–æ–ª—å–∑—É–µ–º 15-–º–∏–Ω—É—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã.")
        minutes_past_hour = now.minute
        if minutes_past_hour < 15:
            next_minute_mark = 15
        elif minutes_past_hour < 30:
            next_minute_mark = 30
        elif minutes_past_hour < 45:
            next_minute_mark = 45
        else:
            next_minute_mark = 0
            next_candle_time = now.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1)
        
        if next_minute_mark > 0:
            next_candle_time = now.replace(minute=next_minute_mark, second=0, microsecond=0)
    
    # –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–π —Å–≤–µ—á–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º +15 –º–∏–Ω—É—Ç –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    if next_candle_time is None:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–π —Å–≤–µ—á–∏ –¥–ª—è —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ {timeframe}")
        next_candle_time = now + timedelta(minutes=15)
        
    return next_candle_time

@dp.message(Command("start"))
async def handle_start(message: types.Message):
    welcome_text = """
üöÄ –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî —Ç–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∏—Ä–∂–µ–π Bitget!

–ö–æ–º–∞–Ω–¥—ã:
- üí∞ –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (/balance)
- üõë –û—Å—Ç–∞–Ω–∞–≤–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –∏ 
     –æ—Ç–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç–Ω—ã–µ –∑–∞—è–≤–∫–∏ (/stop)
- üî• –ü–æ–º–µ–Ω—è—Ç—å –ø–ª–µ—á–æ (/leverage <—á–∏—Å–ª–æ>)
- ‚è± –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∞–π–º—Ñ—Ä–µ–π–º –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π (/timeframe <–∑–Ω–∞—á–µ–Ω–∏–µ>)
- ‚è± –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∞–π–º—Ñ—Ä–µ–π–º –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –º–æ–Ω–µ—Ç—ã (/coin_timeframe <–º–æ–Ω–µ—Ç–∞> <–∑–Ω–∞—á–µ–Ω–∏–µ>)
- üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π (/strategy_status)
- ‚úÖ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏ 
     –ª–∏–º–∏—Ç–Ω—ã–µ –∑–∞—è–≤–∫–∏ (/orders)
- üìä –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º —Å–¥–µ–ª–∫–∞–º (/all_trades)
- üÜî –£–∑–Ω–∞—Ç—å ID —á–∞—Ç–∞ (/get_id)
- üîÑ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç –∫–∞–∫ —Ü–µ–ª–µ–≤–æ–π (/set_chat)
"""

    await message.answer(welcome_text)

async def check_utc_timeframe_alignment():
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É, –¥–µ–ª–∏—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è UTC –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º.
    –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –±–∏—Ä–∂–µ–π, –∫–æ—Ç–æ—Ä–∞—è –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç UTC.
    """
    while True:
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ø–æ UTC (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º timezone)
            now_utc = datetime.now(timezone.utc)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º—É
            is_aligned = False
            alignment_msg = ""
            
            if TIMEFRAME == '45m':  # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è 45-–º–∏–Ω—É—Ç–Ω–æ–≥–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
                hour = now_utc.hour
                minute = now_utc.minute
                
                # –ü–∞—Ç—Ç–µ—Ä–Ω 45-–º–∏–Ω—É—Ç–Ω–æ–≥–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞: 00:00, 00:45, 01:30, 02:15, 03:00...
                hour_mod = hour % 3
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤ —Ç–æ—á–∫–µ –Ω–∞—á–∞–ª–∞ —Å–≤–µ—á–∏
                if hour_mod == 0 and (minute == 0 or minute == 45):
                    is_aligned = True
                elif hour_mod == 1 and minute == 30:
                    is_aligned = True
                elif hour_mod == 2 and minute == 15:
                    is_aligned = True
                
                alignment_msg = f"–®–∞–±–ª–æ–Ω 45m: —á–∞—Å {hour} (mod 3 = {hour_mod}), –º–∏–Ω—É—Ç–∞ {minute}"
                
            elif TIMEFRAME.endswith('m') and TIMEFRAME != '45m':  # –ú–∏–Ω—É—Ç–Ω—ã–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã
                minutes_value = int(TIMEFRAME.replace('m', ''))
                is_aligned = now_utc.minute % minutes_value == 0
                alignment_msg = f"–¢–µ–∫—É—â–∞—è –º–∏–Ω—É—Ç–∞ UTC: {now_utc.minute}, –Ω—É–∂–Ω–∞ –∫—Ä–∞—Ç–Ω–æ—Å—Ç—å {minutes_value}"
                
            elif TIMEFRAME.startswith('1H'):  # 1 —á–∞—Å
                is_aligned = now_utc.minute == 0
                alignment_msg = f"–¢–µ–∫—É—â–∞—è –º–∏–Ω—É—Ç–∞ UTC: {now_utc.minute}, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 0"
                
            elif TIMEFRAME.startswith('4H'):  # 4 —á–∞—Å–∞
                is_aligned = now_utc.hour % 4 == 0 and now_utc.minute == 0
                alignment_msg = f"–¢–µ–∫—É—â–∏–π —á–∞—Å UTC: {now_utc.hour}, –Ω—É–∂–Ω–∞ –∫—Ä–∞—Ç–Ω–æ—Å—Ç—å 4 –∏ –º–∏–Ω—É—Ç–∞ 0"
                
            elif TIMEFRAME.startswith('6H'):  # 6 —á–∞—Å–æ–≤
                is_aligned = now_utc.hour % 6 == 0 and now_utc.minute == 0
                alignment_msg = f"–¢–µ–∫—É—â–∏–π —á–∞—Å UTC: {now_utc.hour}, –Ω—É–∂–Ω–∞ –∫—Ä–∞—Ç–Ω–æ—Å—Ç—å 6 –∏ –º–∏–Ω—É—Ç–∞ 0"
                
            elif TIMEFRAME.startswith('12H'):  # 12 —á–∞—Å–æ–≤
                is_aligned = now_utc.hour % 12 == 0 and now_utc.minute == 0
                alignment_msg = f"–¢–µ–∫—É—â–∏–π —á–∞—Å UTC: {now_utc.hour}, –Ω—É–∂–Ω–∞ –∫—Ä–∞—Ç–Ω–æ—Å—Ç—å 12 –∏ –º–∏–Ω—É—Ç–∞ 0"
                
            elif TIMEFRAME.startswith('1D'):  # 1 –¥–µ–Ω—å
                is_aligned = now_utc.hour == 0 and now_utc.minute == 0
                alignment_msg = f"–¢–µ–∫—É—â–∏–π —á–∞—Å/–º–∏–Ω—É—Ç–∞ UTC: {now_utc.hour}:{now_utc.minute}, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 0:0"
            
            # –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
            if is_aligned:
                logger.info(f"‚è∞ –í—Ä–µ–º—è UTC {now_utc.strftime('%Y-%m-%d %H:%M:%S')} —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—á–∞–ª—É —Å–≤–µ—á–∏ {TIMEFRAME}")
        else:
                logger.debug(f"–í—Ä–µ–º—è UTC {now_utc.strftime('%Y-%m-%d %H:%M:%S')} –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—á–∞–ª—É —Å–≤–µ—á–∏ {TIMEFRAME}. {alignment_msg}")

            # –ñ–¥–µ–º –¥–æ –Ω–∞—á–∞–ª–∞ —Å–ª–µ–¥—É—é—â–µ–π –º–∏–Ω—É—Ç—ã (60 - —Å–µ–∫—É–Ω–¥—ã —Ç–µ–∫—É—â–µ–π –º–∏–Ω—É—Ç—ã)
            seconds_to_next_minute = 60 - now_utc.second
            await asyncio.sleep(seconds_to_next_minute)

    except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤—Ä–µ–º–µ–Ω–∏ UTC —Ç–∞–π–º—Ñ—Ä–µ–π–º—É: {e}")
            logger.error(traceback.format_exc())
            await asyncio.sleep(60)  # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –∂–¥–µ–º –º–∏–Ω—É—Ç—É –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π

# –î–æ–±–∞–≤–∏–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
@dp.message(Command("scan"))
async def handle_scan(message: Message):
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ä—É—á–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –º–æ–Ω–µ—Ç.
    """
    try:
        await message.reply("üîç –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –º–æ–Ω–µ—Ç...")
        await scan_all_coins()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã /scan: {str(e)}")
        logger.error(traceback.format_exc())
        await message.reply(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {str(e)}")

# --- –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã ---

@dp.message(Command("balance"))
async def handle_balance(message: Message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    processing_msg = await message.reply("‚è≥ –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞...")
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
    async def fetch_balance_task():
        try:
            balance = await get_balance()
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
            await processing_msg.edit_text(f"üí∞ –í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {balance:.2f} USDT")
                except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã /balance: {str(e)}")
            logger.error(traceback.format_exc())
            await processing_msg.edit_text(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: {str(e)}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –≤ —Ñ–æ–Ω–µ –∏ –Ω–µ –∂–¥–µ–º –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    asyncio.create_task(fetch_balance_task())

@dp.message(Command("stop"))
async def handle_stop(message: Message):
    """
    –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –∏ –æ—Ç–º–µ–Ω—è–µ—Ç –ª–∏–º–∏—Ç–Ω—ã–µ –∑–∞—è–≤–∫–∏.
    """
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    processing_msg = await message.reply("‚è≥ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫...")
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–¥–µ–ª–æ–∫
    async def stop_trades_task():
        try:
            if not active_trades:
                await processing_msg.edit_text("‚ÑπÔ∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.")
                return
                
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –¥–ª—è –æ—Ç—á–µ—Ç–∞
            active_symbols = list(active_trades.keys())
            
            # –û—Ç–º–µ–Ω—è–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏
            success_count = 0
            error_count = 0
            
            for symbol in active_symbols:
                try:
                    # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ —Ç–µ–∫—É—â–µ–π —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–µ
                    trade_info = active_trades[symbol]
                    side = "sell" if trade_info['side'] == "buy" else "buy"  # –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
                    position_side = "long" if trade_info['side'] == "buy" else "short"
                    
                    # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–µ —Å reduceOnly=True
                    await exchange.create_order(
                        symbol=symbol,
                        type="market",
                        side=side,
                        amount=trade_info['amount'],
                        params={
                            "marginCoin": "USDT",            # ‚úÖ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π
                            "marginMode": "isolated",        # ‚úÖ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π
                            "reduceOnly": True,              # ‚úÖ –≤–∞–∂–Ω–æ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
                            "positionSide": position_side,   # ‚úÖ –¥–ª—è –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ —Ä–µ–∂–∏–º–∞
                            "loanType": "normal"             # ‚úÖ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –¥–ª—è Bitget
                        }
                    )
                    
                    logger.info(f"–ü–æ–∑–∏—Ü–∏—è –ø–æ {symbol} –∑–∞–∫—Ä—ã—Ç–∞ –ø–æ —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–µ")
                            
                            # –£–¥–∞–ª—è–µ–º –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
                            del active_trades[symbol]
                    success_count += 1
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ö–æ–¥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                    await processing_msg.edit_text(
                        f"‚è≥ –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π... {success_count}/{len(active_symbols)} –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
                    )
                    
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ {symbol}: {str(e)}")
                    error_count += 1
                    
            final_message = f"‚úÖ –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.\n"
            final_message += f"–£—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ: {success_count}\n"
            if error_count > 0:
                final_message += f"–û—à–∏–±–æ–∫: {error_count}"
                
            await processing_msg.edit_text(final_message)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ü–µ–ª–µ–≤–æ–π —á–∞—Ç
            if message.chat.id != TARGET_CHAT_ID:
                await bot.send_message(
                    TARGET_CHAT_ID,
                    f"‚ÑπÔ∏è –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –±—ã–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
                )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã /stop: {str(e)}")
            logger.error(traceback.format_exc())
            await processing_msg.edit_text(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–¥–µ–ª–æ–∫: {str(e)}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –≤ —Ñ–æ–Ω–µ –∏ –Ω–µ –∂–¥–µ–º –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    asyncio.create_task(stop_trades_task())

@dp.message(Command("leverage"))
async def handle_leverage(message: Message):
    """
    –ò–∑–º–µ–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä –ø–ª–µ—á–∞ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π.
    –§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã: /leverage <—á–∏—Å–ª–æ>
    """
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    text = message.text.strip()
    
    # –†–∞–∑–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ —á–∞—Å—Ç–∏
    args = text.split()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã
    if len(args) != 2:
        await message.reply("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ: /leverage <—á–∏—Å–ª–æ>")
        return
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–µ—á–∞
    try:
        new_leverage = int(args[1])
    except ValueError:
        await message.reply("‚ö†Ô∏è –ü–ª–µ—á–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º.")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–ª–µ—á–∞
    if new_leverage < 1 or new_leverage > 100:
        await message.reply("‚ö†Ô∏è –ü–ª–µ—á–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 100.")
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    processing_msg = await message.reply(f"‚è≥ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–µ—á–∞ –Ω–∞ {new_leverage}x...")
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–ª–µ—á–∞
    async def change_leverage_task():
        global leverage
        try:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
            old_leverage = leverage
            leverage = new_leverage
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–µ—á–æ –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–Ω–µ—Ç—ã
            symbols = list(active_strategies.keys())
            success_count = 0
            error_count = 0
            logger.info(f"–ü–ª–µ—á–æ –∏–∑–º–µ–Ω–µ–Ω–æ: {old_leverage}x -> {leverage}x (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.from_user.id})")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            final_message = f"‚úÖ –ü–ª–µ—á–æ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ: {old_leverage}x ‚Üí {leverage}x\n"
                
            # –ò–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± —É—Å–ø–µ—à–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            await processing_msg.edit_text(final_message)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ü–µ–ª–µ–≤–æ–π —á–∞—Ç
            if message.chat.id != TARGET_CHAT_ID:
                await bot.send_message(
                    TARGET_CHAT_ID,
                    f"‚ÑπÔ∏è –ü–ª–µ—á–æ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ {leverage}x –¥–ª—è –≤—Å–µ—Ö –º–æ–Ω–µ—Ç"
                )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã /leverage: {str(e)}")
            logger.error(traceback.format_exc())
            await processing_msg.edit_text(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–ª–µ—á–∞: {str(e)}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –≤ —Ñ–æ–Ω–µ –∏ –Ω–µ –∂–¥–µ–º –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    asyncio.create_task(change_leverage_task())

@dp.message(Command("orders"))
async def handle_orders(message: Message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–∏—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö –∏ –ª–∏–º–∏—Ç–Ω—ã—Ö –∑–∞—è–≤–∫–∞—Ö.
    """
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    processing_msg = await message.reply("‚è≥ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∑–∏—Ü–∏—è—Ö –∏ –æ—Ä–¥–µ—Ä–∞—Ö...")
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    async def fetch_orders_task():
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏—è—Ö —Å –±–∏—Ä–∂–∏
            positions = await exchange.fetch_positions(params={"marginCoin": "USDT"})
            active_positions = [p for p in positions if float(p['contracts']) > 0]
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –æ—Ä–¥–µ—Ä–∞—Ö
            orders = await exchange.fetch_open_orders(params={"marginCoin": "USDT"})
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–∑–∏—Ü–∏—è—Ö
            if active_positions:
                positions_message = "üìä *–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏:*\n\n"
                for pos in active_positions:
                    symbol = pos['symbol']
                    side = "–õ–û–ù–ì" if pos['side'] == 'long' else "–®–û–†–¢"
                    size = float(pos['contracts'])
                    entry_price = float(pos['entryPrice'])
                    leverage = pos['leverage']
                    unrealized_pnl = float(pos['unrealizedPnl'])
                    pnl_percent = (unrealized_pnl / (size * entry_price / float(leverage))) * 100
                    
                    positions_message += f"üîπ *{symbol}*\n"
                    positions_message += f"   –¢–∏–ø: {side}\n"
                    positions_message += f"   –†–∞–∑–º–µ—Ä: {size:.6f}\n"
                    positions_message += f"   –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞: {entry_price:.4f}\n"
                    positions_message += f"   –ü–ª–µ—á–æ: {leverage}x\n"
                    positions_message += f"   PnL: {unrealized_pnl:.2f} USDT ({pnl_percent:.2f}%)\n\n"
            else:
                positions_message = "üìä *–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏:* –Ω–µ—Ç\n\n"
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ—Ä–¥–µ—Ä–∞—Ö
            if orders:
                orders_message = "üìã *–û—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞:*\n\n"
                for order in orders:
                    symbol = order['symbol']
                    order_type = order['type'].upper()
                    side = "–ü–û–ö–£–ü–ö–ê" if order['side'] == 'buy' else "–ü–†–û–î–ê–ñ–ê"
                    price = order['price'] if order['price'] else "–†—ã–Ω–æ—á–Ω–∞—è"
                    amount = order['amount']
                    
                    orders_message += f"üî∏ *{symbol}*\n"
                    orders_message += f"   –¢–∏–ø: {order_type}\n"
                    orders_message += f"   –°—Ç–æ—Ä–æ–Ω–∞: {side}\n"
                    orders_message += f"   –¶–µ–Ω–∞: {price}\n"
                    orders_message += f"   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {amount:.6f}\n\n"
            else:
                orders_message = "üìã *–û—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞:* –Ω–µ—Ç"
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            await processing_msg.edit_text(positions_message + orders_message, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã /orders: {str(e)}")
            logger.error(traceback.format_exc())
            await processing_msg.edit_text(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –æ—Ä–¥–µ—Ä–∞—Ö: {str(e)}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –≤ —Ñ–æ–Ω–µ –∏ –Ω–µ –∂–¥–µ–º –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    asyncio.create_task(fetch_orders_task())

@dp.message(Command("all_trades"))
async def handle_all_trades(message: Message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º —Å–¥–µ–ª–∫–∞–º.
    """
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    processing_msg = await message.reply("‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –ø–æ –≤—Å–µ–º —Å–¥–µ–ª–∫–∞–º...")
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
    async def generate_report_task():
        try:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –ø–æ —Å–¥–µ–ª–∫–∞–º
            report_file = await trade_reporter.generate_trade_report()
            
            if report_file and os.path.exists(report_file):
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –æ—Ç—á–µ—Ç–∞
                doc = FSInputFile(report_file)
                # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å —Ñ–∞–π–ª–æ–º
                await processing_msg.delete()
                await message.reply_document(
                    document=doc,
                    caption="üìä –û—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º —Å–¥–µ–ª–∫–∞–º."
                )
            else:
                await processing_msg.edit_text("‚ÑπÔ∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–¥–µ–ª–∫–∞—Ö –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞.")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã /all_trades: {str(e)}")
            logger.error(traceback.format_exc())
            await processing_msg.edit_text(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞ –ø–æ —Å–¥–µ–ª–∫–∞–º: {str(e)}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –≤ —Ñ–æ–Ω–µ –∏ –Ω–µ –∂–¥–µ–º –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    asyncio.create_task(generate_report_task())

@dp.message(Command("get_id"))
async def handle_get_id(message: Message):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ID —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞.
    """
    try:
        chat_id = message.chat.id
        await message.reply(f"üÜî ID —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞: `{chat_id}`", parse_mode="Markdown")
        logger.info(f"ID —á–∞—Ç–∞ –∑–∞–ø—Ä–æ—à–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {message.from_user.id}: {chat_id}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã /get_id: {str(e)}")
        await message.reply(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ ID —á–∞—Ç–∞: {str(e)}")

@dp.message(Command("set_chat"))
async def handle_set_chat(message: Message):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —á–∞—Ç –∫–∞–∫ —Ü–µ–ª–µ–≤–æ–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
    """
    try:
        global TARGET_CHAT_ID
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π ID –¥–ª—è –ª–æ–≥–∞
        old_chat_id = TARGET_CHAT_ID
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π ID
        TARGET_CHAT_ID = message.chat.id
        
        logger.info(f"–¶–µ–ª–µ–≤–æ–π —á–∞—Ç –∏–∑–º–µ–Ω–µ–Ω: {old_chat_id} -> {TARGET_CHAT_ID} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.from_user.id})")
        
        # –ò–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await message.reply(
            f"‚úÖ –¢–µ–∫—É—â–∏–π —á–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ —Ü–µ–ª–µ–≤–æ–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.\n"
            f"ID —á–∞—Ç–∞: `{TARGET_CHAT_ID}`", 
            parse_mode="Markdown"
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await bot.send_message(
            TARGET_CHAT_ID,
            f"‚ÑπÔ∏è –≠—Ç–æ—Ç —á–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –±–æ—Ç–∞."
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã /set_chat: {str(e)}")
        logger.error(traceback.format_exc())
        await message.reply(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Ü–µ–ª–µ–≤–æ–≥–æ —á–∞—Ç–∞: {str(e)}")

async def clean_expired_signals():
    """–û—á–∏—â–∞–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Å–∏–≥–Ω–∞–ª—ã –∏–∑ —Å–ª–æ–≤–∞—Ä—è recent_signals"""
    global recent_signals
    
    while True:
        try:
            current_time = datetime.now()
            symbols_to_remove = []
            
            # –ò—â–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Å–∏–≥–Ω–∞–ª—ã
            for symbol, (signal_time, signal_type) in recent_signals.items():
                time_diff = (current_time - signal_time).total_seconds()
                if time_diff > SIGNAL_COOLDOWN:
                    symbols_to_remove.append(symbol)
            
            # –£–¥–∞–ª—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Å–∏–≥–Ω–∞–ª—ã
            for symbol in symbols_to_remove:
                del recent_signals[symbol]
                logger.info(f"–£–¥–∞–ª–µ–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Å–∏–≥–Ω–∞–ª –¥–ª—è {symbol}")
            
            # –ñ–¥–µ–º 60 —Å–µ–∫—É–Ω–¥ –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            await asyncio.sleep(60)
    
    except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å–∏–≥–Ω–∞–ª–æ–≤: {e}")
        logger.error(traceback.format_exc())
            await asyncio.sleep(60)

# --- –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ---
async def main():
    start_time = datetime.now()
    logger.info("====== –¢–û–†–ì–û–í–´–ô –ë–û–¢ –ó–ê–ü–£–©–ï–ù ======")
    logger.info(f"–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: {start_time.strftime('%Y-%m-%d %H:%M:%S')}")
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∏—Ä–∂–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º fetch_markets –≤–º–µ—Å—Ç–æ fetch_status)
        markets = await exchange.fetch_markets()
        logger.info(f"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Bitget —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –î–æ—Å—Ç—É–ø–Ω–æ {len(markets)} —Ä—ã–Ω–∫–æ–≤")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ –±–∏—Ä–∂–µ: {str(e)}")
        logger.error(traceback.format_exc())
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–Ω–µ—Ç —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞–º–∏
    scan_task = asyncio.create_task(periodic_scan())
    logger.info("–ó–∞–¥–∞—á–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—É—â–µ–Ω–∞")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤—Ä–µ–º–µ–Ω–∏ UTC —Ç–∞–π–º—Ñ—Ä–µ–π–º—É
    utc_check_task = asyncio.create_task(check_utc_timeframe_alignment())
    logger.info("–ó–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ UTC –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—É—â–µ–Ω–∞")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –æ—á–∏—Å—Ç–∫–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
    signals_clean_task = asyncio.create_task(clean_expired_signals())
    logger.info("–ó–∞–¥–∞—á–∞ –æ—á–∏—Å—Ç–∫–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–ø—É—â–µ–Ω–∞")
    
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        logger.info("–ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞...")
        await dp.start_polling(bot)
    except asyncio.CancelledError:
        logger.info("–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã")
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ä–∞–±–æ—Ç–µ Telegram –±–æ—Ç–∞: {str(e)}")
        logger.error(traceback.format_exc())
    finally:
        logger.info("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–∞–¥–∞—á –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π...")
        # –û—Ç–º–µ–Ω—è–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º
        for task in [scan_task, utc_check_task, signals_clean_task]:
            if not task.done():
                task.cancel()
                try:
                    await task
            except asyncio.CancelledError:
                pass
                
        await exchange.close()  # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∏—Ä–∂–µ–π
        await bot.session.close()  # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é –±–æ—Ç–∞
        
        uptime = datetime.now() - start_time
        uptime_seconds = uptime.total_seconds()
        bot_logger.log_bot_stop(uptime_seconds)

async def call_bitget_api(endpoint, method="GET", params=None):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ API Bitget —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π.
    
    Args:
        endpoint (str): –≠–Ω–¥–ø–æ–∏–Ω—Ç API, –Ω–∞–ø—Ä–∏–º–µ—Ä "/api/v2/mix/order/place-plan-order"
        method (str): HTTP –º–µ—Ç–æ–¥ (GET, POST –∏ —Ç.–¥.)
        params (dict): –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
        
    Returns:
        dict: –û—Ç–≤–µ—Ç –æ—Ç API Bitget
    """
    try:
        api_key = API_KEY
        secret_key = SECRET_KEY
        passphrase = PASSPHRASE
        timestamp = str(int(time.time() * 1000))
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É
        if not endpoint.startswith('/'):
            endpoint = '/' + endpoint
            
        # –ü–æ–ª–Ω—ã–π URL
        url = f"https://api.bitget.com{endpoint}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç endpoint –∏ planType
        adjusted_params = params.copy() if params else {}
        
        if endpoint == "/api/v2/mix/order/place-plan-order" and params:
            plan_type = params.get("planType", "")
            
            # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–π –ø–ª–∞–Ω (normal_plan), —É–¥–∞–ª—è–µ–º delegateCount, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if plan_type == "normal_plan" and "delegateCount" in adjusted_params:
                del adjusted_params["delegateCount"]
                logger.info("–£–¥–∞–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä delegateCount –¥–ª—è normal_plan")
                
            # –ï—Å–ª–∏ —ç—Ç–æ —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø (trailing_stop_plan), –¥–æ–±–∞–≤–ª—è–µ–º delegateCount, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            elif plan_type == "trailing_stop_plan" and "delegateCount" not in adjusted_params:
                adjusted_params["delegateCount"] = "1"
                logger.info("–î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä delegateCount –¥–ª—è trailing_stop_plan")
        
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
        body = ""
        if adjusted_params:
            body = json.dumps(adjusted_params)
            
        # –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å—å
        message = timestamp + method + endpoint + body
        signature = base64.b64encode(
            hmac.new(
                secret_key.encode('utf-8'), 
                message.encode('utf-8'), 
                hashlib.sha256
            ).digest()
        ).decode()
        
        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
        headers = {
            'ACCESS-KEY': api_key,
            'ACCESS-SIGN': signature,
            'ACCESS-TIMESTAMP': timestamp,
            'ACCESS-PASSPHRASE': passphrase,
            'Content-Type': 'application/json'
        }
        
        logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Bitget API: {method} {url}")
        logger.info(f"–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞: {adjusted_params}")
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
        async with aiohttp.ClientSession() as session:
            if method == "GET":
                async with session.get(url, headers=headers) as response:
                    result = await response.json()
            elif method == "POST":
                async with session.post(url, headers=headers, data=body) as response:
                    result = await response.json()
            else:
                logger.error(f"–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –º–µ—Ç–æ–¥ HTTP: {method}")
                return None
                
        logger.info(f"–û—Ç–≤–µ—Ç –æ—Ç Bitget API: {result}")
        return result
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ Bitget API: {str(e)}")
        logger.error(traceback.format_exc())
        return None

if __name__ == "__main__":
    try:
        logger.info("–ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞...")
    asyncio.run(main()) 
    except KeyboardInterrupt:
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C)")
    except Exception as e:
        logger.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {str(e)}")
        logger.critical(traceback.format_exc()) 